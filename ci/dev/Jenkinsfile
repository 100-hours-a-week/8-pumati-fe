pipeline {
    // íŒŒì´í”„ë¼ì¸ ì „ì²´ë¥¼ Kubernetes Podì—ì„œ ì‹¤í–‰
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  # system ë…¸ë“œì— ìš°ì„  ë°°ì¹˜ë˜ë„ë¡ ë…¸ë“œ ì…€ë ‰í„° ì„¤ì •
  nodeSelector:
    node-type: "system"
  # system ë…¸ë“œê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì–´í”¼ë‹ˆí‹° ì„¤ì •
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: node-type
            operator: In
            values: ["system"]
      - weight: 50
        preference:
          matchExpressions:
          - key: kubernetes.io/instance-type
            operator: In
            values: ["t3.medium", "t3a.medium"]
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  containers:
  - name: nodejs
    image: cimg/node:20.10
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
    # t3.medium ìŠ¤í™ì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • - Node.js ë¹Œë“œìš©
    resources:
      requests:
        memory: "1Gi"      # 1GB ìš”ì²­ (npm ë¹Œë“œì— ì¶©ë¶„)
        cpu: "500m"        # 0.5 CPU ìš”ì²­
      limits:
        memory: "2.5Gi"    # 2.5GB ì œí•œ (t3.medium 4GB ì¤‘ ì—¬ìœ ìˆê²Œ)
        cpu: "1500m"       # 1.5 CPU ì œí•œ (t3.medium 2 vCPU ì¤‘ ëŒ€ë¶€ë¶„)
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.9.0-debug
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 0
      runAsGroup: 0
    # t3.medium ìŠ¤í™ì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • - Kaniko ë¹Œë“œìš©
    resources:
      requests:
        memory: "1Gi"      # 1GB ìš”ì²­ (ì´ë¯¸ì§€ ë¹Œë“œìš©)
        cpu: "500m"        # 0.5 CPU ìš”ì²­
      limits:
        memory: "3Gi"      # 3GB ì œí•œ (ì´ë¯¸ì§€ ë¹Œë“œì— ì¶©ë¶„)
        cpu: "1500m"       # 1.5 CPU ì œí•œ
    volumeMounts:
    - name: workspace-volume
      mountPath: /workspace
    - name: kaniko-secret
      mountPath: /kaniko/.docker
  - name: aws-cli
    image: cimg/aws:2023.05
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
    # t3.medium ìŠ¤í™ì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • - AWS CLIìš© (ê°€ë²¼ìš´ ì‘ì—…)
    resources:
      requests:
        memory: "256Mi"    # 256MB ìš”ì²­ (AWS CLI ì‘ì—…ìš©)
        cpu: "200m"        # 0.2 CPU ìš”ì²­
      limits:
        memory: "512Mi"    # 512MB ì œí•œ (AWS CLIì— ì¶©ë¶„)
        cpu: "400m"        # 0.4 CPU ì œí•œ
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir: {}
  - name: kaniko-secret
    emptyDir: {}
            '''
        }
    }

    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // AWS ê³µê°œ ì •ë³´ (ê¹ƒì— ì˜¬ë ¤ë„ ì•ˆì „)
        AWS_REGION = 'ap-northeast-2'                    // ì„œìš¸ ë¦¬ì „
        ECR_REPOSITORY = 'pumati-dev-frontend-ecr'       // ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„

        // ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì • (ë¸Œëœì¹˜ëª…ê³¼ ë¹Œë“œ ë²ˆí˜¸ ì¡°í•©)
        IMAGE_TAG = "${BRANCH_NAME}-${BUILD_NUMBER}"

        // Node.js í™˜ê²½ ì„¤ì •
        NODE_ENV = 'production'
        NPM_CONFIG_CACHE = '/home/jenkins/agent/.npm'
        CI = 'true'
    }

    stages {
        // 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        stage('Checkout') {
            steps {
                container('nodejs') {
                    echo 'ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ'
                    script {
                        // Git ì •ë³´ í™•ì¸
                        try {
                            def gitCommit = sh(
                                script: 'git rev-parse HEAD',
                                returnStdout: true
                            ).trim()
                            echo "Git Commit: ${gitCommit}"
                        } catch (Exception e) {
                            echo "Git commit ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                        }

                        try {
                            def gitBranch = sh(
                                script: 'git branch --show-current || echo "detached"',
                                returnStdout: true
                            ).trim()
                            echo "Git Branch: ${gitBranch}"
                        } catch (Exception e) {
                            echo "Git branch ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                        }

                        // ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
                        sh 'pwd'
                        sh 'ls -la'
                    }
                }
            }
        }

        // 2. í™˜ê²½ ì„¤ì • íŒŒì¼ ì¤€ë¹„
        stage('Setup Environment') {
            steps {
                container('nodejs') {
                    echo 'í™˜ê²½ ì„¤ì • íŒŒì¼ ë° AWS ì •ë³´ ì¤€ë¹„ ì¤‘...'

                    script {
                        // AWS ê³„ì • IDë¡œ Docker ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •
                        withCredentials([string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID')]) {
                            env.DOCKER_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
                            env.LATEST_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
                            echo "Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                            echo "Latest ì´ë¯¸ì§€: ${env.LATEST_IMAGE_NAME}"
                        }
                    }

                    // Jenkins Credentialsì—ì„œ .env íŒŒì¼ ê°€ì ¸ì™€ì„œ cicd/dev/ ë””ë ‰í† ë¦¬ì— ë³µì‚¬
                    withCredentials([file(credentialsId: 'fe-env', variable: 'ENV_FILE')]) {
                        sh '''
                            # cicd/dev/ ë””ë ‰í† ë¦¬ ìƒì„± (í˜¹ì‹œ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                            mkdir -p cicd/dev/

                            # Jenkins credentialsì—ì„œ ê°€ì ¸ì˜¨ .env íŒŒì¼ì„ ì ì ˆí•œ ìœ„ì¹˜ì— ë³µì‚¬
                            cp $ENV_FILE cicd/dev/.env

                            # .env íŒŒì¼ì´ ì œëŒ€ë¡œ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
                            if [ -f "cicd/dev/.env" ]; then
                                FILE_SIZE=$(wc -l < cicd/dev/.env)
                                echo "âœ… .env íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ"
                                echo "íŒŒì¼ í¬ê¸°: $FILE_SIZE ì¤„"

                                # .env íŒŒì¼ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                                if [ "$FILE_SIZE" -eq 0 ]; then
                                    echo "âš ï¸ .env íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
                                    echo "Jenkins Credentials 'fe-env'ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
                                    echo "ë¹Œë“œëŠ” ê³„ì† ì§„í–‰í•˜ì§€ë§Œ í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                                else
                                    echo "âœ… .env íŒŒì¼ì— $FILE_SIZE ê°œì˜ í™˜ê²½ ë³€ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤."
                                fi
                            else
                                echo "âŒ .env íŒŒì¼ ì¤€ë¹„ ì‹¤íŒ¨"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }

        // 3. Docker ë¹Œë“œ ì¤€ë¹„ (íŒŒì¼ í™•ì¸)
        stage('Prepare for Docker Build') {
            steps {
                container('nodejs') {
                    echo 'Docker ë¹Œë“œë¥¼ ìœ„í•œ íŒŒì¼ ì¤€ë¹„ ë° í™•ì¸ ì¤‘...'
                    script {
                        sh '''
                            echo "=== Docker ë¹Œë“œ ì¤€ë¹„ ==="
                            echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"

                            # í•„ìš”í•œ íŒŒì¼ë“¤ í™•ì¸
                            echo "ğŸ“‹ í•„ìˆ˜ íŒŒì¼ í™•ì¸:"
                            echo "- package.json:"
                            ls -la package.json && echo "  âœ… ì¡´ì¬" || echo "  âŒ ì—†ìŒ"

                            echo "- Dockerfile.dev:"
                            ls -la cicd/dev/Dockerfile.dev && echo "  âœ… ì¡´ì¬" || echo "  âŒ ì—†ìŒ"

                            echo "- .env íŒŒì¼:"
                            ls -la cicd/dev/.env && echo "  âœ… ì¡´ì¬" || echo "  âŒ ì—†ìŒ"

                            echo "- tsconfig.json:"
                            ls -la tsconfig.json && echo "  âœ… ì¡´ì¬" || echo "  âŒ ì—†ìŒ"

                            echo "- src ë””ë ‰í† ë¦¬:"
                            ls -la src/ && echo "  âœ… ì¡´ì¬" || echo "  âŒ ì—†ìŒ"

                            echo "- next.config íŒŒì¼:"
                            ls -la next.config.* && echo "  âœ… ì¡´ì¬" || echo "  âŒ ì—†ìŒ"

                            # .env íŒŒì¼ì„ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ë³µì‚¬ (Dockerfile.devì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´)
                            if [ -f "cicd/dev/.env" ]; then
                                echo "ğŸ“ .env íŒŒì¼ì„ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ë³µì‚¬ ì¤‘..."
                                cp cicd/dev/.env .env
                                echo "âœ… .env íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
                                echo "íŒŒì¼ ë‚´ìš© í™•ì¸ (ì²« 3ì¤„):"
                                head -3 .env || echo "íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                            else
                                echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œëŠ” ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤."
                            fi

                            echo "âœ… Docker ë¹Œë“œ ì¤€ë¹„ ì™„ë£Œ"
                            echo "ğŸ³ Kanikoë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤"
                        '''
                    }
                }
            }
        }

        // 4. ECR ë¡œê·¸ì¸ ë° ì„¤ì •
        stage('Setup ECR') {
            steps {
                container('aws-cli') {
                    echo 'ECR ë¡œê·¸ì¸ ë° ë¦¬í¬ì§€í† ë¦¬ ì„¤ì • ì¤‘...'
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh 'aws --version'
                        sh 'aws sts get-caller-identity'

                        // ECR ë¦¬í¬ì§€í† ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
                        sh """
                            aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} || \\
                            aws ecr create-repository --repository-name ${ECR_REPOSITORY} --region ${AWS_REGION}
                        """

                        echo 'âœ… ECR ì„¤ì • ì™„ë£Œ'
                    }
                }
            }
        }

        // 5. Kanikoë¥¼ ì‚¬ìš©í•œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        stage('Build and Push Docker Image') {
            steps {
                script {
                    // ECR ì¸ì¦ ì •ë³´ ì¤€ë¹„
                    container('aws-cli') {
                        echo 'ECR ì¸ì¦ ì •ë³´ ì¤€ë¹„ ì¤‘...'
                        withCredentials([
                            string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                            aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')
                        ]) {
                            // ECR ë¡œê·¸ì¸ í† í° ìƒì„± ë° Docker config ìƒì„±
                            sh '''
                                # ECR ë¡œê·¸ì¸ í† í° ìƒì„±
                                ECR_TOKEN=$(aws ecr get-login-password --region $AWS_REGION)
                                ECR_REGISTRY="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"

                                # Kanikoìš© Docker config ìƒì„±
                                mkdir -p /tmp/kaniko-config
                                cat > /tmp/kaniko-config/config.json << EOF
{
    "auths": {
        "$ECR_REGISTRY": {
            "username": "AWS",
            "password": "$ECR_TOKEN"
        }
    }
}
EOF

                                echo "âœ… ECR ì¸ì¦ ì •ë³´ ì¤€ë¹„ ì™„ë£Œ"
                                echo "Registry: $ECR_REGISTRY"
                            '''
                        }
                    }

                    // Kaniko ì»¨í…Œì´ë„ˆì—ì„œ ë¹Œë“œ ë° í‘¸ì‹œ ìˆ˜í–‰
                    container('kaniko') {
                        echo 'Kanikoë¥¼ ì‚¬ìš©í•œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ ì¤‘...'

                        withCredentials([
                            string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID')
                        ]) {
                            sh '''
                                # ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
                                cd /workspace

                                echo "ğŸ”§ Kaniko í™˜ê²½ í™•ì¸ ì¤‘..."
                                echo "ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
                                ls -la

                                # Docker config ë³µì‚¬
                                echo "ğŸ” ECR ì¸ì¦ ì •ë³´ ì„¤ì • ì¤‘..."
                                cp /tmp/kaniko-config/config.json /kaniko/.docker/config.json

                                # Dockerfile.dev ì¡´ì¬ í™•ì¸
                                if [ ! -f "cicd/dev/Dockerfile.dev" ]; then
                                    echo "âŒ Dockerfile.devë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                                    echo "ğŸ“ cicd/dev/ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
                                    ls -la cicd/dev/ || echo "ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                                    exit 1
                                fi

                                echo "âœ… Dockerfile.dev í™•ì¸ ì™„ë£Œ"

                                # Kanikoë¥¼ ì‚¬ìš©í•œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
                                echo "ğŸ”¨ Kaniko ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
                                echo "ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸: $(pwd)"
                                echo "Dockerfile: cicd/dev/Dockerfile.dev"
                                echo "ì´ë¯¸ì§€ íƒœê·¸: $DOCKER_IMAGE_NAME"

                                # Kaniko executor ì‹¤í–‰
                                /kaniko/executor \\
                                    --dockerfile=cicd/dev/Dockerfile.dev \\
                                    --context=dir:///workspace \\
                                    --destination="$DOCKER_IMAGE_NAME" \\
                                    --destination="$LATEST_IMAGE_NAME" \\
                                    --cache=true \\
                                    --cache-ttl=24h \\
                                    --verbosity=info

                                echo "âœ… Kaniko ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"
                            '''
                        }

                        echo 'ğŸ‰ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ!'
                        echo "ğŸ“¦ ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                        echo "ğŸ“¦ Latest: ${env.LATEST_IMAGE_NAME}"
                    }
                }
            }
        }

        // 6. GitOps - í—¬ë¦„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ë° í‘¸ì‹œ
        stage('Update GitOps Repository') {
            steps {
                container('nodejs') {
                    echo 'GitOps ë¦¬í¬ì§€í† ë¦¬ ì—…ë°ì´íŠ¸ ì¤‘...'

                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN')
                    ]) {
                        script {
                            try {
                                sh '''
                                    # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
                                    mkdir -p /tmp/gitops
                                    cd /tmp/gitops

                                    echo "ğŸ”„ GitOps ë¦¬í¬ì§€í† ë¦¬ í´ë¡  ì¤‘..."
                                    # GitHub í† í°ì„ ì‚¬ìš©í•˜ì—¬ í´ë¡  (í† í° ë§ˆìŠ¤í‚¹)
                                    git clone https://x-access-token:${GITHUB_TOKEN}@github.com/100-hours-a-week/8-pumati-cloud.git .

                                    # Git ì„¤ì • (ë¡œì»¬ ë¦¬í¬ì§€í† ë¦¬ì—ì„œë§Œ)
                                    git config user.name "Jenkins CI"
                                    git config user.email "jenkins@pumati.com"

                                    # jacky ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ (í—¬ë¦„ ì°¨íŠ¸ê°€ ìˆëŠ” ë¸Œëœì¹˜)
                                    echo "ğŸ”„ jacky ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ì¤‘..."
                                    git checkout jacky

                                    # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
                                    git branch -a
                                    git status

                                    # values.yaml íŒŒì¼ ê²½ë¡œ í™•ì¸
                                    echo "ğŸ“ í—¬ë¦„ ì°¨íŠ¸ êµ¬ì¡° í™•ì¸..."
                                    find . -name "values.yaml" -type f
                                    ls -la aws/dev/gitops/helm/frontend/ || echo "í”„ë¡ íŠ¸ì—”ë“œ í—¬ë¦„ ë””ë ‰í† ë¦¬ í™•ì¸ ì¤‘..."
                                '''

                                // ì´ë¯¸ì§€ íƒœê·¸ ì •ë³´ ì„¤ì •
                                def newImageTag = "${env.IMAGE_TAG}"
                                def fullImageName = "${env.DOCKER_IMAGE_NAME}"

                                sh """
                                    cd /tmp/gitops

                                    # values.yaml íŒŒì¼ ê²½ë¡œ ì„¤ì • (frontend ë””ë ‰í† ë¦¬ ë‚´)
                                    VALUES_FILE="aws/dev/gitops/helm/frontend/values.yaml"

                                    if [ -f "\$VALUES_FILE" ]; then
                                        echo "ğŸ“ values.yaml íŒŒì¼ ë°œê²¬: \$VALUES_FILE"
                                        echo "í˜„ì¬ ë‚´ìš©:"
                                        cat "\$VALUES_FILE"

                                        echo ""
                                        echo "ğŸ”„ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ ì¤‘..."
                                        echo "ìƒˆ ì´ë¯¸ì§€: ${fullImageName}"
                                        echo "ìƒˆ íƒœê·¸: ${newImageTag}"

                                        # ë°±ì—… ìƒì„±
                                        cp "\$VALUES_FILE" "\$VALUES_FILE.backup"

                                        # sedë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                                        # image.tag ë˜ëŠ” tag í•„ë“œ ì—…ë°ì´íŠ¸
                                        if grep -q "tag:" "\$VALUES_FILE"; then
                                            # tag: í˜•íƒœë¡œ ë˜ì–´ ìˆëŠ” ê²½ìš°
                                            sed -i "s|tag:.*|tag: \\"${newImageTag}\\"|g" "\$VALUES_FILE"
                                        elif grep -q "image:" "\$VALUES_FILE"; then
                                            # image: í˜•íƒœë¡œ ë˜ì–´ ìˆëŠ” ê²½ìš° (ì „ì²´ ì´ë¯¸ì§€ ê²½ë¡œ)
                                            sed -i "s|image:.*|image: \\"${fullImageName}\\"|g" "\$VALUES_FILE"
                                        else
                                            echo "âš ï¸ ì´ë¯¸ì§€ íƒœê·¸ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì— ì¶”ê°€í•©ë‹ˆë‹¤."
                                            echo "" >> "\$VALUES_FILE"
                                            echo "# Updated by Jenkins CI/CD" >> "\$VALUES_FILE"
                                            echo "image:" >> "\$VALUES_FILE"
                                            echo "  tag: \\"${newImageTag}\\"" >> "\$VALUES_FILE"
                                        fi

                                        echo ""
                                        echo "ğŸ“ ì—…ë°ì´íŠ¸ëœ ë‚´ìš©:"
                                        cat "\$VALUES_FILE"

                                        # Git ë³€ê²½ì‚¬í•­ í™•ì¸
                                        echo ""
                                        echo "ğŸ“Š Git ë³€ê²½ì‚¬í•­:"
                                        git diff "\$VALUES_FILE" || true

                                        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                                        if git diff --quiet "\$VALUES_FILE"; then
                                            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
                                        else
                                            echo "âœ… ë³€ê²½ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ë° í‘¸ì‹œ ì§„í–‰..."

                                            # Git add, commit, push
                                            git add "\$VALUES_FILE"
                                            git commit -m "ğŸš€ Update frontend image tag to ${newImageTag}

                                            - Image: ${fullImageName}
                                            - Build: ${BUILD_NUMBER}
                                            - Branch: ${BRANCH_NAME}
                                            - Commit: \$(git -C /home/jenkins/agent rev-parse --short HEAD 2>/dev/null || echo 'unknown')
                                            - Updated by Jenkins CI/CD"

                                            # ì›ê²© ë¦¬í¬ì§€í† ë¦¬ì— í‘¸ì‹œ (jacky ë¸Œëœì¹˜ë¡œ)
                                            git push origin jacky

                                            echo "ğŸ‰ GitOps ë¦¬í¬ì§€í† ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
                                        fi
                                    else
                                        echo "âŒ values.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: \$VALUES_FILE"
                                        echo "ğŸ“ ì‚¬ìš© ê°€ëŠ¥í•œ íŒŒì¼ë“¤:"
                                        find . -name "*.yaml" -o -name "*.yml" | head -20
                                        exit 1
                                    fi
                                """
                            } catch (Exception e) {
                                echo "âŒ GitOps ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.getMessage()}"
                                echo 'ğŸ” ë””ë²„ê·¸ ì •ë³´:'
                                sh '''
                                    cd /tmp/gitops 2>/dev/null || echo "gitops ë””ë ‰í† ë¦¬ ì—†ìŒ"
                                    pwd
                                    ls -la
                                    git status 2>/dev/null || echo "Git ìƒíƒœ í™•ì¸ ë¶ˆê°€"
                                '''
                                // GitOps ì‹¤íŒ¨ëŠ” ì „ì²´ ë¹Œë“œë¥¼ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•ŠìŒ
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }

        // 7. ë¹Œë“œ ì •ë¦¬
        stage('Cleanup') {
            steps {
                container('nodejs') {
                    echo 'ë¹Œë“œ ì •ë¦¬ ì¤‘...'
                    sh '''
                        # í™˜ê²½ íŒŒì¼ ì •ë¦¬ (ë³´ì•ˆ)
                        rm -f cicd/dev/.env || true
                        rm -rf /home/jenkins/agent/.npm || true
                        echo "ì •ë¦¬ ì™„ë£Œ"
                    '''
                }
            }
        }
    }

    // ë¹Œë“œ í›„ ì²˜ë¦¬
    post {
        always {
            container('nodejs') {
                script {
                    echo 'ë¹Œë“œ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ. ì‘ì—… ê³µê°„ì„ ì •ë¦¬í•©ë‹ˆë‹¤.'

                    // Kubernetes Pod í™˜ê²½ì—ì„œëŠ” ìˆ˜ë™ìœ¼ë¡œ ì •ë¦¬
                    try {
                        sh '''
                            echo "ì‘ì—… ê³µê°„ ì •ë¦¬ ì‹œì‘..."
                            # ë¯¼ê°í•œ íŒŒì¼ë“¤ ì •ë¦¬
                            rm -f cicd/dev/.env || true
                            rm -rf /home/jenkins/agent/.npm || true
                            rm -rf /tmp/gitops || true

                            # ë¹Œë“œ ê²°ê³¼ë¬¼ ì •ë¦¬ (ì„ íƒì )
                            rm -rf node_modules || true
                            rm -rf build || true
                            rm -rf dist || true
                            rm -rf .next || true

                            echo "âœ… ì‘ì—… ê³µê°„ ì •ë¦¬ ì™„ë£Œ"
                        '''
                    } catch (Exception e) {
                        echo "ì‘ì—… ê³µê°„ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): ${e.getMessage()}"
                    }
                }
            }
        }

        success {
            script {
                echo 'âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° GitOps ì—…ë°ì´íŠ¸ ì„±ê³µ! ğŸ‰'
                echo "ğŸ“¦ Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê·¸: ${env.IMAGE_TAG}"
                echo "ğŸ“ ECR ë¦¬í¬ì§€í† ë¦¬: ${ECR_REPOSITORY}"
                echo "ğŸŒ AWS ë¦¬ì „: ${AWS_REGION}"
                echo 'ğŸ”„ GitOps: ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤'
                echo 'ğŸ“‹ í—¬ë¦„ ì°¨íŠ¸: aws/dev/gitops/helm/frontend/values.yaml ì—…ë°ì´íŠ¸ë¨'
            }
        }

        failure {
            script {
                echo 'âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨!'
                echo 'ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”.'
                echo "ğŸŒ ë¹Œë“œ URL: ${env.BUILD_URL}"
            }
        }

        unstable {
            script {
                echo 'âš ï¸ ë¹Œë“œ ë¶ˆì•ˆì •'
                echo 'ğŸ“Š í…ŒìŠ¤íŠ¸ì—ì„œ ì¼ë¶€ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            }
        }
    }
}
