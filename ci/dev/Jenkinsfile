pipeline {
    agent any

    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì • - ECR ê´€ë ¨ ì •ë³´ë§Œ
    environment {
        AWS_REGION = 'ap-northeast-2'                    // AWS ë¦¬ì „ (ì„œìš¸)
        ECR_REPOSITORY = 'pumati-fe'                     // ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
        IMAGE_TAG = "${BUILD_NUMBER}"                    // ì´ë¯¸ì§€ íƒœê·¸ (ë¹Œë“œ ë²ˆí˜¸ ì‚¬ìš©)
        AWS_ACCOUNT_ID = credentials('aws-account-id')   // AWS ê³„ì • ID (Jenkins credentialsì—ì„œ ê°€ì ¸ì˜´)
        ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    }

    stages {
        stage('ì²´í¬ì•„ì›ƒ') {
            steps {
                // Git ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                checkout scm
            }
        }

        stage('.env íŒŒì¼ ì¤€ë¹„') {
            steps {
                script {
                    // Jenkins Credentialsì—ì„œ .env íŒŒì¼ ê°€ì ¸ì™€ì„œ ì ì ˆí•œ ìœ„ì¹˜ì— ë³µì‚¬
                    echo '.env íŒŒì¼ ì¤€ë¹„ ì¤‘...'
                    withCredentials([file(credentialsId: 'fe-env', variable: 'ENV_FILE')]) {
                        sh """
                            # cicd/dev/ ë””ë ‰í† ë¦¬ ìƒì„± (í˜¹ì‹œ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                            mkdir -p cicd/dev/

                            # Jenkins credentialsì—ì„œ ê°€ì ¸ì˜¨ .env íŒŒì¼ì„ ì ì ˆí•œ ìœ„ì¹˜ì— ë³µì‚¬
                            cp \$ENV_FILE cicd/dev/.env

                            # .env íŒŒì¼ì´ ì œëŒ€ë¡œ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë³´ì•ˆìƒ ë‚´ìš©ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ)
                            if [ -f "cicd/dev/.env" ]; then
                                echo "âœ… .env íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ"
                                echo "íŒŒì¼ í¬ê¸°: \$(wc -l < cicd/dev/.env) ì¤„"
                            else
                                echo "âŒ .env íŒŒì¼ ì¤€ë¹„ ì‹¤íŒ¨"
                                exit 1
                            fi
                        """
                    }
                }
            }
        }

        stage('Docker ì´ë¯¸ì§€ ë¹Œë“œ') {
            steps {
                script {
                    // Dockerfile.devë¥¼ ì‚¬ìš©í•˜ì—¬ Docker ì´ë¯¸ì§€ ë¹Œë“œ (ì˜ì¡´ì„± ì„¤ì¹˜ + ë¹Œë“œ ëª¨ë‘ í¬í•¨)
                    echo 'Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘...'
                    sh """
                        docker build -f cicd/dev/Dockerfile.dev \
                            -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} \
                            -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest \
                            .
                    """
                    echo 'âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ'
                }
            }
        }

        stage('ECR ë¡œê·¸ì¸') {
            steps {
                script {
                    // AWS ECRì— ë¡œê·¸ì¸
                    echo 'ECR ë¡œê·¸ì¸ ì¤‘...'
                    sh """
                        aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin ${ECR_REGISTRY}
                    """
                }
            }
        }

        stage('ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ') {
            steps {
                script {
                    // ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ECRì— í‘¸ì‹œ
                    echo 'ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘...'
                    sh """
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                if (env.BRANCH_NAME == 'dev') {
                    echo 'ğŸ‰ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì—…ë¡œë“œ ì„±ê³µ!'
                    echo "âœ… ì´ë¯¸ì§€: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                    echo "âœ… ìµœì‹  ì´ë¯¸ì§€: ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"
                } else {
                    echo 'âœ… dev ë¸Œëœì¹˜ê°€ ì•„ë‹ˆë¯€ë¡œ ë¹Œë“œë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.'
                }
            }
        }
        failure {
            echo 'âŒ ì´ë¯¸ì§€ ë¹Œë“œ ë˜ëŠ” ì—…ë¡œë“œ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
        }
        always {
            script {
                if (env.BRANCH_NAME == 'dev') {
                    // ì„ì‹œë¡œ ìƒì„±í•œ .env íŒŒì¼ ì •ë¦¬ (ë³´ì•ˆ)
                    sh '''
                        rm -f cicd/dev/.env || true
                        docker system prune -f || true
                    '''
                }
            }
        }
    }
}
